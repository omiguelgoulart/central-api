// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum StatusSocio {
  ATIVO
  INADIMPLENTE
  CANCELADO
}

enum StatusPagamento {
  PENDENTE
  PAGO
  ATRASADO
  CANCELADO
}

enum Periodicidade {
  MENSAL
  TRIMESTRAL
  SEMESTRAL
  ANUAL
}

enum MetodoPagamento {
  BOLETO
  CARTAO_CREDITO
  CARTAO_DEBITO
  DINHEIRO
  PIX
}

enum StatusAssinatura {
  ATIVA
  CANCELADA
  SUSPENSA
  EXPIRADA
}

enum StatusFatura {
  ABERTA
  PAGA
  ATRASADA
  CANCELADA
}

model Admin {
  id           String   @id @default(uuid())
  nome         String
  email        String   @unique
  senha        String
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  jogosCriados     Jogo[] @relation("JogoCriadoPor")
  jogosAtualizados Jogo[] @relation("JogoAtualizadoPor")

  @@map("admins")
}

model Torcedor {
  id                 String       @id @default(uuid())
  matricula          String       @unique
  nome               String
  email              String       @unique
  senha              String
  telefone           String?
  cpf                String?      @unique
  dataNascimento     DateTime?
  genero             String?
  fotoUrl            String?
  enderecoLogradouro String?
  enderecoNumero     String?
  enderecoBairro     String?
  enderecoCidade     String?
  enderecoUF         String?
  enderecoCEP        String?
  statusSocio        StatusSocio?
  inadimplenteDesde  DateTime?
  aceitaTermosEm     DateTime?
  aceitaMarketing    Boolean?     @default(false)
  aceitaMarketingEm  DateTime?
  origemCadastro     String?
  documentoFrenteUrl String?
  documentoVersoUrl  String?
  gatewayClienteId   String?
  faceId             String?
  assinaturas        Assinatura[]
  pagamentos         Pagamento[]  @relation("TorcedorPagamentos")
  ingressos          Ingresso[]   @relation("IngressoSocio")
  criadoEm           DateTime     @default(now())
  atualizadoEm       DateTime     @updatedAt

  @@index([statusSocio])
  @@index([cpf])
  @@index([email])
  @@map("torcedores") // üî¥ ESSENCIAL
}

model Plano {
  id            String        @id @default(uuid())
  nome          String        @unique
  descricao     String?
  valor         Decimal
  periodicidade Periodicidade

  // extras pro card
  isFeatured Boolean @default(false)
  badgeLabel String?
  ordem      Int     @default(0)

  // rela√ß√µes
  assinaturas  Assinatura[]
  beneficios   Beneficio[]
  criadoEm     DateTime     @default(now())
  atualizadoEm DateTime     @updatedAt

  @@map("planos")
}

model Beneficio {
  id        String  @id @default(uuid())
  slug      String  @unique
  titulo    String
  descricao String?
  icone     String?
  ativo     Boolean @default(true)

  // rela√ß√£o com plano
  planoId String
  plano   Plano  @relation(fields: [planoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // controle visual/ordem dentro do card do plano
  ordem      Int     @default(0)
  destaque   Boolean @default(false)
  observacao String?

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([planoId])
  @@map("beneficios")
}

model Assinatura {
  id                String           @id @default(uuid())
  torcedorId        String
  planoId           String
  status            StatusAssinatura @default(ATIVA)
  inicioEm          DateTime
  expiraEm          DateTime? // ok ser opcional (plano sem prazo fixo)
  proximaCobrancaEm DateTime?

  // Auditoria de ciclo de vida
  canceladaEm        DateTime?
  motivoCancelamento String?
  suspensaEm         DateTime?
  retomadaEm         DateTime?

  // Cobran√ßa
  periodicidade       Periodicidade @default(MENSAL) // crie o enum (MENSAL/TRIMESTRAL/ANUAL...)
  valorAtual          Decimal?      @db.Decimal(10, 2)
  moeda               String?       @default("BRL")
  gatewayClienteId    String? // id do cliente no gateway (ex.: ASAAS/Stripe)
  gatewayAssinaturaId String? // id da assinatura no gateway

  torcedor Torcedor @relation(fields: [torcedorId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  plano    Plano    @relation(fields: [planoId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  faturas  Fatura[]

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // √çndices que ajudam MUITO no dia a dia
  @@index([torcedorId, status])
  @@index([planoId])
  @@index([status, proximaCobrancaEm])
  @@index([torcedorId, planoId, status])
}

model Fatura {
  id           String           @id @default(uuid())
  assinaturaId String
  competencia  String // "2025-09" por ex.
  valor        Decimal
  status       StatusFatura     @default(ABERTA)
  vencimentoEm DateTime
  pagoEm       DateTime?
  referencia   String?          @unique
  metodo       MetodoPagamento?

  assinatura Assinatura  @relation(fields: [assinaturaId], references: [id])
  pagamentos Pagamento[]

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([assinaturaId, status, vencimentoEm, competencia])
}

model Pagamento {
  id             String          @id @default(uuid())
  torcedorId     String
  valor          Decimal          @db.Decimal(10, 2)
  status         StatusPagamento  @default(PENDENTE)
  dataVencimento DateTime
  pagoEm         DateTime?
  referencia     String?          @unique
  metodo         MetodoPagamento
  descricao      String?

  faturaId       String?

  gatewayPaymentId String? 

  torcedor Torcedor @relation("TorcedorPagamentos", fields: [torcedorId], references: [id])
  fatura   Fatura?  @relation(fields: [faturaId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  ingressos Ingresso[] // Um pagamento pode ter v√°rios ingressos

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([torcedorId])
  @@index([faturaId])
  @@index([status, dataVencimento, metodo])
  @@map("pagamentos")
}

enum StatusIngresso {
  PENDENTE
  VALIDO
  USADO
  CANCELADO
  EXPIRADO
  ESTORNADO
}

enum TipoLote {
  INTEIRA
  MEIA
  CORTESIA
  PROMO
}

enum TipoSetor {
  ARQUIBANCADA
  CADEIRA
  CAMAROTE
  VISITANTE
  ACESSIVEL
}


model Jogo {
  id        String   @id @default(uuid())
  nome      String
  data      DateTime
  local String @default("Bento Freitas")
  descricao String?

  lotes     Lote[]
  ingressos Ingresso[]
  setores   JogoSetor[]

  criadoPorId     String?
  atualizadoPorId String?
  criadoPor       Admin? @relation("JogoCriadoPor", fields: [criadoPorId], references: [id])
  atualizadoPor   Admin? @relation("JogoAtualizadoPor", fields: [atualizadoPorId], references: [id])

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([data])
  @@map("jogos")
}

model Setor {
  id         String  @id @default(uuid())
  nome       String
  capacidade Int          // capacidade estrutural do est√°dio (m√°ximo f√≠sico)

  criadoEm     DateTime  @default(now())
  atualizadoEm DateTime  @updatedAt
  jogos        JogoSetor[]

  @@unique([nome])
  @@map("setores")
}

model JogoSetor {
  id            String   @id @default(uuid())
  jogoId        String
  setorId       String
  capacidade    Int
  aberto        Boolean  @default(true)
  tipo          TipoSetor @default(ARQUIBANCADA)

  jogo  Jogo  @relation(fields: [jogoId], references: [id])
  setor Setor @relation(fields: [setorId], references: [id])
  lotes Lote[]
  
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@unique([jogoId, setorId])
  @@index([jogoId, setorId])
  @@map("jogos_setores")
}

model Lote {
  id              String    @id @default(uuid())
  nome            String
  tipo            TipoLote  @default(INTEIRA)
  quantidade      Int?      // opcional: sub-limite do lote dentro do setor
  precoUnitario   Decimal   @db.Decimal(10,2)
  inicioVendas    DateTime?
  fimVendas       DateTime?
  limitePorCPF    Int?

  jogoId      String
  jogoSetorId String

  jogo      Jogo      @relation(fields: [jogoId], references: [id])
  jogoSetor JogoSetor @relation(fields: [jogoSetorId], references: [id])
  ingressos Ingresso[]

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([jogoId, nome])
  @@index([jogoSetorId])
  @@map("lotes")
}

model Ingresso {
  id           String         @id @default(uuid())
  torcedorId   String?
  jogoId       String
  loteId       String?        // nullable para permitir remover/definir depois
  qrCode       String         @unique
  valor        Decimal        @db.Decimal(10, 2)
  status       StatusIngresso @default(VALIDO)
  criadoEm     DateTime       @default(now())
  usadoEm      DateTime?
  atualizadoEm DateTime       @updatedAt
  pagamentoId  String?

  socio        Torcedor?   @relation("IngressoSocio", fields: [torcedorId], references: [id])
  jogo         Jogo        @relation(fields: [jogoId], references: [id])
  lote         Lote?       @relation(fields: [loteId], references: [id])
  pagamento    Pagamento?  @relation(fields: [pagamentoId], references: [id])
  checkins     Checkin[]

  @@index([jogoId, status, loteId])
  @@map("ingressos")
}

model Checkin {
  id         String   @id @default(uuid())
  ingressoId String
  feitoEm    DateTime @default(now())
  feitoPor   String?
  local      String?

  ingresso Ingresso @relation(fields: [ingressoId], references: [id])

  @@index([ingressoId])
  @@map("checkins")
}
